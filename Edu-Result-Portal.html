<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduResults Portal - Live Results System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #17a2b8;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 15px 50px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: var(--gradient-primary);
            color: white;
            padding: 1.2rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 2.2rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 1.6rem;
            font-weight: 700;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 25px;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            padding: 8px 12px;
            border-radius: 6px;
        }

        nav a:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .hero {
            background: var(--gradient-primary), url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 5rem 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }

        .hero-content {
            position: relative;
            z-index: 2;
        }

        .hero h2 {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .hero p {
            font-size: 1.3rem;
            max-width: 700px;
            margin: 0 auto 2.5rem;
            opacity: 0.9;
        }

        .btn {
            display: inline-block;
            background: var(--gradient-secondary);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
        }

        .btn-secondary {
            background: var(--gradient-secondary);
        }

        .btn-success {
            background: var(--gradient-success);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid white;
        }

        .form-section {
            padding: 4rem 0;
        }

        .form-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 3rem;
            box-shadow: var(--shadow-lg);
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--gradient-primary);
        }

        .form-section h2 {
            text-align: center;
            margin-bottom: 2.5rem;
            color: var(--primary);
            font-size: 2.2rem;
            position: relative;
        }

        .form-section h2:after {
            content: '';
            display: block;
            width: 100px;
            height: 5px;
            background: var(--gradient-primary);
            margin: 15px auto;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 1.8rem;
        }

        label {
            display: block;
            margin-bottom: 0.7rem;
            font-weight: 600;
            color: var(--primary);
            font-size: 1.05rem;
        }

        .input-with-icon {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
            font-size: 1.2rem;
        }

        input, select {
            width: 100%;
            padding: 15px 15px 15px 50px;
            border: 2px solid #e1e5ee;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: #f8f9fa;
        }

        input:focus, select:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            background: white;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 2rem;
        }

        .results-section {
            padding: 4rem 0;
            display: none;
        }

        .results-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 3rem;
            box-shadow: var(--shadow-lg);
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .results-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--gradient-success);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-header h2 {
            color: var(--primary);
            font-size: 2rem;
        }

        .status-badge {
            background: var(--gradient-success);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .student-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .results-table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .results-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:hover {
            background-color: #f8f9fa;
        }

        .grade-excellent {
            color: var(--success);
            font-weight: 700;
        }

        .grade-good {
            color: var(--secondary);
            font-weight: 700;
        }

        .grade-average {
            color: var(--warning);
            font-weight: 700;
        }

        .grade-poor {
            color: var(--accent);
            font-weight: 700;
        }

        .summary {
            margin-top: 2.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .summary-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .chart-section {
            margin-top: 3rem;
            padding: 2rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-top: 1.5rem;
        }

        .chart-box {
            flex: 1;
            min-width: 300px;
            height: 320px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
            display: none;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .debug-content {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .features {
            padding: 5rem 0;
            background: white;
        }

        .section-title {
            text-align: center;
            margin-bottom: 3.5rem;
            color: var(--primary);
            font-size: 2.5rem;
        }

        .section-title:after {
            content: '';
            display: block;
            width: 100px;
            height: 5px;
            background: var(--gradient-primary);
            margin: 15px auto;
            border-radius: 5px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2.5rem;
        }

        .feature-card {
            background: white;
            padding: 2.5rem 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-top: 4px solid var(--secondary);
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-lg);
        }

        .feature-icon {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 1.5rem;
        }

        .feature-card h3 {
            margin-bottom: 1.2rem;
            color: var(--primary);
            font-size: 1.4rem;
        }

        footer {
            background: var(--primary);
            color: white;
            padding: 4rem 0 1.5rem;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 2.5rem;
            margin-bottom: 2.5rem;
        }

        .footer-section h3 {
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            position: relative;
            padding-bottom: 10px;
        }

        .footer-section h3:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 3px;
            background: var(--secondary);
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section ul li {
            margin-bottom: 0.8rem;
        }

        .footer-section a {
            color: #ddd;
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-section a:hover {
            color: white;
            padding-left: 5px;
        }

        .copyright {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: #ddd;
        }

        .spinner {
            display: none;
            text-align: center;
            margin: 2.5rem 0;
        }

        .spinner i {
            font-size: 3rem;
            color: var(--secondary);
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .alert i {
            font-size: 1.5rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid var(--success);
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid var(--accent);
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 5px solid var(--info);
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 5px solid var(--warning);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.offline {
            background: var(--accent);
        }

        .toggle-debug {
            background: transparent;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            nav ul {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .hero h2 {
                font-size: 2.2rem;
            }

            .hero p {
                font-size: 1.1rem;
            }

            .form-container {
                padding: 2rem 1.5rem;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .student-info {
                grid-template-columns: 1fr;
            }

            .chart-container {
                flex-direction: column;
            }
            
            .chart-box {
                min-width: 100%;
            }

            .summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>EduResults Portal</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="#home"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="#results"><i class="fas fa-poll"></i> Check Results</a></li>
                    <li><a href="#about"><i class="fas fa-info-circle"></i> About</a></li>
                    <li><a href="#contact"><i class="fas fa-envelope"></i> Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero" id="home">
        <div class="container hero-content">
            <h2>Academic Excellence Made Accessible</h2>
            <p>Access student results quickly and securely with our advanced educational platform. Designed for students, parents, and educators.</p>
            <a href="#results" class="btn btn-outline"><i class="fas fa-arrow-down"></i> Check Results Now</a>
        </div>
    </section>

    <section class="form-section" id="results">
        <div class="container">
            <div class="form-container">
                <h2><i class="fas fa-search"></i> Check Your Results</h2>
                
                <div class="alert alert-success" id="successAlert">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Success!</strong> Results retrieved successfully!
                    </div>
                </div>
                
                <div class="alert alert-error" id="errorAlert">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>
                        <strong>Error!</strong> <span id="errorMessage">Unable to retrieve results. Please try again.</span>
                    </div>
                </div>

                <div class="alert alert-info" id="infoAlert">
                    <i class="fas fa-info-circle"></i>
                    <div id="infoMessage">System ready! Fill the form to check results.</div>
                </div>

                <div class="alert alert-warning" id="fallbackAlert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Notice:</strong> N8N connection failed. Showing sample data instead.
                    </div>
                </div>
                
                <form id="resultForm">
                    <div class="form-group">
                        <label for="studentName"><i class="fas fa-user"></i> Student Full Name</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="studentName" name="studentName" placeholder="Enter student's full name" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="studentClass"><i class="fas fa-users"></i> Class</label>
                        <div class="input-with-icon">
                            <i class="fas fa-users input-icon"></i>
                            <select id="studentClass" name="studentClass" required>
                                <option value="">Select Class</option>
                                <option value="class1">Class 1</option>
                                <option value="class2">Class 2</option>
                                <option value="class3">Class 3</option>
                                <option value="class4">Class 4</option>
                                <option value="class5">Class 5</option>
                                <option value="class6">Class 6</option>
                                <option value="class7">Class 7</option>
                                <option value="class8">Class 8</option>
                                <option value="class9">Class 9</option>
                                <option value="class10">Class 10</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="examType"><i class="fas fa-file-alt"></i> Exam Type</label>
                        <div class="input-with-icon">
                            <i class="fas fa-file-alt input-icon"></i>
                            <select id="examType" name="examType" required>
                                <option value="">Select Exam Type</option>
                                <option value="midterm">Mid-Term Examination</option>
                                <option value="final">Final Examination</option>
                                <option value="quarterly">Quarterly Examination</option>
                                <option value="annual">Annual Examination</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="academicYear"><i class="fas fa-calendar-alt"></i> Academic Year</label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar-alt input-icon"></i>
                            <select id="academicYear" name="academicYear" required>
                                <option value="">Select Academic Year</option>
                                <option value="2023-2024">2023-2024</option>
                                <option value="2022-2023">2022-2023</option>
                                <option value="2021-2022">2021-2022</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-download"></i> Get Results
                        </button>
                    </div>

                    <div class="connection-status">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="connectionStatus">Checking connection...</span>
                    </div>
                </form>

                <div class="debug-panel" id="debugPanel">
                    <div class="debug-header">
                        <h3><i class="fas fa-bug"></i> Debug Information</h3>
                        <button class="toggle-debug" id="toggleDebug">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    <div class="debug-content" id="debugContent">
                        <!-- Debug information will appear here -->
                    </div>
                </div>
                
                <div class="spinner" id="loadingSpinner">
                    <i class="fas fa-spinner"></i>
                    <p>Fetching your results...</p>
                </div>
            </div>
        </div>
    </section>

    <section class="results-section" id="resultsDisplay">
        <div class="container">
            <div class="results-container">
                <div class="results-header">
                    <h2><i class="fas fa-award"></i> Academic Results</h2>
                    <div class="status-badge">
                        <i class="fas fa-check-circle"></i> Results Verified
                    </div>
                </div>
                
                <div class="student-info">
                    <div class="info-item">
                        <span class="info-label">Student Name</span>
                        <span class="info-value" id="displayStudentName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Class/Grade</span>
                        <span class="info-value" id="displayStudentClass">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Exam Type</span>
                        <span class="info-value" id="displayExamType">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Academic Year</span>
                        <span class="info-value" id="displayAcademicYear">-</span>
                    </div>
                </div>
                
                <div class="results-table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Marks Obtained</th>
                                <th>Maximum Marks</th>
                                <th>Grade</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="summary">
                    <div class="summary-item">
                        <div class="summary-value" id="totalMarks">-</div>
                        <div class="summary-label">Total Marks</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="percentage">-</div>
                        <div class="summary-label">Percentage</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="overallGrade">-</div>
                        <div class="summary-label">Overall Grade</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="resultStatus">-</div>
                        <div class="summary-label">Result Status</div>
                    </div>
                </div>

                <div class="chart-section">
                    <h3><i class="fas fa-chart-bar"></i> Performance Analysis</h3>
                    <div class="chart-container">
                        <div class="chart-box">
                            <canvas id="marksChart"></canvas>
                        </div>
                        <div class="chart-box">
                            <canvas id="gradeDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="button-group" style="margin-top: 2rem;">
                    <button class="btn btn-primary" id="printResult">
                        <i class="fas fa-print"></i> Print Result
                    </button>
                    <button class="btn btn-secondary" id="newSearchBtn">
                        <i class="fas fa-search"></i> New Search
                    </button>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const form = document.getElementById('resultForm');
            const resultsSection = document.getElementById('resultsDisplay');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const successAlert = document.getElementById('successAlert');
            const errorAlert = document.getElementById('errorAlert');
            const infoAlert = document.getElementById('infoAlert');
            const fallbackAlert = document.getElementById('fallbackAlert');
            const printButton = document.getElementById('printResult');
            const newSearchBtn = document.getElementById('newSearchBtn');
            const debugPanel = document.getElementById('debugPanel');
            const debugContent = document.getElementById('debugContent');
            const toggleDebug = document.getElementById('toggleDebug');
            const statusDot = document.getElementById('statusDot');
            const connectionStatus = document.getElementById('connectionStatus');
            const errorMessage = document.getElementById('errorMessage');
            const infoMessage = document.getElementById('infoMessage');
            
            // Chart instances
            let marksChart = null;
            let gradeDistributionChart = null;
            
            // N8N Webhook URL
            const N8N_WEBHOOK_URL = 'https://n8n.srv1060272.hstgr.cloud/webhook/result-check';
            
            // Initialize the application
            function init() {
                // Test connection on load
                testN8NConnection();
                
                // Set up event listeners
                setupEventListeners();
                
                // Show initial info
                showInfo('System ready! Fill the form to check results from N8N backend.');
            }
            
            // Set up all event listeners
            function setupEventListeners() {
                form.addEventListener('submit', handleFormSubmit);
                printButton.addEventListener('click', handlePrint);
                newSearchBtn.addEventListener('click', handleNewSearch);
                toggleDebug.addEventListener('click', toggleDebugPanel);
            }
            
            // Test N8N connection
            async function testN8NConnection() {
                try {
                    const testResponse = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            test: true, 
                            action: 'connection_test',
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    if (testResponse.ok) {
                        setConnectionStatus(true, 'Connected to NBN Backend');
                    } else {
                        setConnectionStatus(false, 'NBN connection failed');
                    }
                } catch (error) {
                    setConnectionStatus(false, 'NBN connection failed');
                    console.warn('N8N connection test failed:', error);
                }
            }
            
            // Set connection status UI
            function setConnectionStatus(connected, message) {
                if (connected) {
                    statusDot.classList.remove('offline');
                    connectionStatus.textContent = message;
                    connectionStatus.style.color = '#27ae60';
                } else {
                    statusDot.classList.add('offline');
                    connectionStatus.textContent = message;
                    connectionStatus.style.color = '#e74c3c';
                }
            }
            
            // Show info alert
            function showInfo(message) {
                infoMessage.textContent = message;
                infoAlert.style.display = 'flex';
                setTimeout(() => {
                    infoAlert.style.display = 'none';
                }, 5000);
            }
            
            // Show debug info
            function showDebugInfo(message) {
                debugContent.textContent = message;
                debugPanel.style.display = 'block';
            }
            
            // Toggle debug panel
            function toggleDebugPanel() {
                debugPanel.style.display = debugPanel.style.display === 'block' ? 'none' : 'block';
            }
            
            // Handle form submission
            async function handleFormSubmit(e) {
                e.preventDefault();
                
                const formData = {
                    studentName: document.getElementById('studentName').value,
                    studentClass: document.getElementById('studentClass').value,
                    examType: document.getElementById('examType').value,
                    academicYear: document.getElementById('academicYear').value
                };
                
                if (!formData.studentName || !formData.studentClass || !formData.examType || !formData.academicYear) {
                    showError('Please fill all fields');
                    return;
                }
                
                // Reset UI state
                resetUIState();
                loadingSpinner.style.display = 'block';
                
                // Try to fetch from N8N
                const result = await fetchFromN8N(formData);
                
                if (result.success) {
                    // Success - display results from N8N
                    displayResults(result.data);
                    successAlert.style.display = 'flex';
                    fallbackAlert.style.display = 'none';
                    showInfo('Results retrieved from N8N backend!');
                } else {
                    // Show error
                    showError('Failed to retrieve results from N8N backend. Please try again.');
                    showDebugInfo(`N8N Error: ${result.error}`);
                    // Don't show fallback data on error
                    return;
                }
                
                // Show results section if we have data
                if (result.success) {
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                }
                
                loadingSpinner.style.display = 'none';
            }
            
            // Fetch data from N8N - FIXED VERSION (No body stream error)
            async function fetchFromN8N(formData) {
                // Create request data in multiple formats to handle different N8N setups
                const requestData = {
                    // Format 1: Simple key-value pairs
                    studentName: formData.studentName,
                    studentClass: formData.studentClass,
                    examType: formData.examType,
                    academicYear: formData.academicYear,
                    
                    // Format 2: Additional metadata
                    timestamp: new Date().toISOString(),
                    source: 'EduResults Portal',
                    action: 'get_results',
                    
                    // Format 3: AI Agent compatible
                    chatInput: `Get results for Student: ${formData.studentName}, Class: ${formData.studentClass}, Exam: ${formData.examType}, Year: ${formData.academicYear}`
                };
                
                try {
                    showDebugInfo(`Sending request to N8N: ${N8N_WEBHOOK_URL}\nRequest Data: ${JSON.stringify(requestData, null, 2)}`);
                    
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    showDebugInfo(`Response Status: ${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    // Clone the response to read it multiple times if needed
                    const responseClone = response.clone();
                    
                    // First try to parse as JSON
                    let data;
                    let responseText = '';
                    
                    try {
                        data = await response.json();
                        showDebugInfo(`Response Data (JSON): ${JSON.stringify(data, null, 2)}`);
                    } catch (jsonError) {
                        // If JSON parsing fails, get the text response from the clone
                        responseText = await responseClone.text();
                        showDebugInfo(`Response Data (Text): ${responseText}`);
                        
                        // Try to parse the text as JSON
                        try {
                            data = JSON.parse(responseText);
                        } catch (e) {
                            // If it's not JSON, treat it as plain text
                            data = { text: responseText };
                        }
                    }
                    
                    // Handle different response formats from N8N
                    if (data && data.success && data.result) {
                        return { success: true, data: data.result };
                    } else if (data && data.response) {
                        const parsedData = parseAIResponse(data.response, formData);
                        return { success: true, data: parsedData };
                    } else if (data && data.text) {
                        // Handle text response from N8N
                        const parsedData = parseAIResponse(data.text, formData);
                        return { success: true, data: parsedData };
                    } else if (data && data.studentName) {
                        return { success: true, data: data };
                    } else if (data && data.message) {
                        // Handle case where N8N returns a message instead of data
                        const parsedData = parseAIResponse(data.message, formData);
                        return { success: true, data: parsedData };
                    } else {
                        // If no recognizable format, return error
                        throw new Error('Unrecognized response format from N8N');
                    }
                } catch (error) {
                    console.error('N8N request failed:', error);
                    // Return error instead of falling back to sample data
                    return { success: false, error: error.message };
                }
            }
            
            // Handle print button
            function handlePrint() {
                window.print();
            }
            
            // Handle new search button
            function handleNewSearch() {
                resultsSection.style.display = 'none';
                form.reset();
                resetUIState();
                showInfo('Ready for new search. Fill the form to check results from N8N backend.');
            }
            
            // Show error message
            function showError(message) {
                errorMessage.textContent = message;
                errorAlert.style.display = 'flex';
                setTimeout(() => {
                    errorAlert.style.display = 'none';
                }, 5000);
            }
            
            // Reset UI state
            function resetUIState() {
                successAlert.style.display = 'none';
                errorAlert.style.display = 'none';
                fallbackAlert.style.display = 'none';
                debugPanel.style.display = 'none';
            }
            
            // Parse AI response - IMPROVED VERSION
            function parseAIResponse(aiResponse, formData) {
                console.log("Parsing AI Response:", aiResponse);
                
                // Extract student name
                let studentName = formData.studentName || "Student";
                const nameMatch = aiResponse.match(/Name:\s*([^\n]+)/i) || 
                                 aiResponse.match(/Student:\s*([^\n]+)/i) ||
                                 aiResponse.match(/Name\s*([^\n]+)/i);
                if (nameMatch) {
                    studentName = nameMatch[1].trim();
                }
                
                // Extract subjects and marks
                const subjects = [];
                
                // Math
                const mathMatch = aiResponse.match(/Math:\s*(\d+)\/(\d+)/i) || aiResponse.match(/Mathematics:\s*(\d+)\/(\d+)/i);
                if (mathMatch) {
                    const marks = parseInt(mathMatch[1]);
                    const maxMarks = parseInt(mathMatch[2]);
                    subjects.push({
                        name: "Mathematics",
                        marksObtained: marks,
                        maxMarks: maxMarks,
                        grade: calculateGrade(marks/maxMarks * 100),
                        remarks: getRemarks(marks/maxMarks * 100)
                    });
                }
                
                // English
                const englishMatch = aiResponse.match(/English:\s*(\d+)\/(\d+)/i);
                if (englishMatch) {
                    const marks = parseInt(englishMatch[1]);
                    const maxMarks = parseInt(englishMatch[2]);
                    subjects.push({
                        name: "English",
                        marksObtained: marks,
                        maxMarks: maxMarks,
                        grade: calculateGrade(marks/maxMarks * 100),
                        remarks: getRemarks(marks/maxMarks * 100)
                    });
                }
                
                // Urdu
                const urduMatch = aiResponse.match(/Urdu:\s*(\d+)\/(\d+)/i);
                if (urduMatch) {
                    const marks = parseInt(urduMatch[1]);
                    const maxMarks = parseInt(urduMatch[2]);
                    subjects.push({
                        name: "Urdu",
                        marksObtained: marks,
                        maxMarks: maxMarks,
                        grade: calculateGrade(marks/maxMarks * 100),
                        remarks: getRemarks(marks/maxMarks * 100)
                    });
                }
                
                // Pak Study
                const pakStudyMatch = aiResponse.match(/Pak Study:\s*(\d+)\/(\d+)/i) || aiResponse.match(/Pak Study[^:]*:\s*(\d+)\/(\d+)/i);
                if (pakStudyMatch) {
                    const marks = parseInt(pakStudyMatch[1]);
                    const maxMarks = parseInt(pakStudyMatch[2]);
                    subjects.push({
                        name: "Pak Study",
                        marksObtained: marks,
                        maxMarks: maxMarks,
                        grade: calculateGrade(marks/maxMarks * 100),
                        remarks: getRemarks(marks/maxMarks * 100)
                    });
                }
                
                // Islamiat
                const islamiatMatch = aiResponse.match(/Islamia:\s*(\d+)\/(\d+)/i) || aiResponse.match(/Islamiat:\s*(\d+)\/(\d+)/i);
                if (islamiatMatch) {
                    const marks = parseInt(islamiatMatch[1]);
                    const maxMarks = parseInt(islamiatMatch[2]);
                    subjects.push({
                        name: "Islamiat",
                        marksObtained: marks,
                        maxMarks: maxMarks,
                        grade: calculateGrade(marks/maxMarks * 100),
                        remarks: getRemarks(marks/maxMarks * 100)
                    });
                }
                
                // Science (if mentioned)
                const scienceMatch = aiResponse.match(/Science:\s*(\d+)\/(\d+)/i);
                if (scienceMatch) {
                    const marks = parseInt(scienceMatch[1]);
                    const maxMarks = parseInt(scienceMatch[2]);
                    subjects.push({
                        name: "Science",
                        marksObtained: marks,
                        maxMarks: maxMarks,
                        grade: calculateGrade(marks/maxMarks * 100),
                        remarks: getRemarks(marks/maxMarks * 100)
                    });
                }
                
                // If no subjects found in the response, return empty array
                if (subjects.length === 0) {
                    console.warn("No subjects found in AI response");
                    return {
                        studentName: studentName,
                        class: formData.studentClass.replace('class', 'Class '),
                        examType: formData.examType,
                        academicYear: formData.academicYear,
                        subjects: [],
                        totalMarks: 0,
                        percentage: 0,
                        overallGrade: "N/A",
                        resultStatus: "No Data"
                    };
                }
                
                // Calculate totals
                const totalMarks = subjects.reduce((sum, subject) => sum + subject.marksObtained, 0);
                const maxTotalMarks = subjects.reduce((sum, subject) => sum + subject.maxMarks, 0);
                const percentage = maxTotalMarks > 0 ? ((totalMarks / maxTotalMarks) * 100).toFixed(1) : 0;

                return {
                    studentName: studentName,
                    class: formData.studentClass.replace('class', 'Class '),
                    examType: formData.examType,
                    academicYear: formData.academicYear,
                    subjects: subjects,
                    totalMarks: totalMarks,
                    percentage: percentage,
                    overallGrade: calculateGrade(percentage),
                    resultStatus: percentage >= 33 ? "Pass" : "Fail"
                };
            }
            
            // Calculate grade based on percentage
            function calculateGrade(percentage) {
                if (percentage >= 90) return "A+";
                if (percentage >= 80) return "A";
                if (percentage >= 70) return "B";
                if (percentage >= 60) return "C";
                if (percentage >= 50) return "D";
                return "F";
            }
            
            // Get remarks based on percentage
            function getRemarks(percentage) {
                if (percentage >= 90) return "Outstanding";
                if (percentage >= 80) return "Excellent";
                if (percentage >= 70) return "Very Good";
                if (percentage >= 60) return "Good";
                if (percentage >= 50) return "Satisfactory";
                return "Needs Improvement";
            }
            
            // Display results
            function displayResults(resultData) {
                console.log("Displaying results:", resultData);
                
                // Update student info
                document.getElementById('displayStudentName').textContent = resultData.studentName;
                document.getElementById('displayStudentClass').textContent = resultData.class;
                document.getElementById('displayExamType').textContent = resultData.examType;
                document.getElementById('displayAcademicYear').textContent = resultData.academicYear;
                
                // Update results table
                const tableBody = document.getElementById('resultsTableBody');
                tableBody.innerHTML = '';
                
                if (resultData.subjects && resultData.subjects.length > 0) {
                    resultData.subjects.forEach(subject => {
                        const row = document.createElement('tr');
                        
                        let gradeClass = '';
                        if (subject.grade === 'A+' || subject.grade === 'A') {
                            gradeClass = 'grade-excellent';
                        } else if (subject.grade === 'B+' || subject.grade === 'B') {
                            gradeClass = 'grade-good';
                        } else if (subject.grade === 'C+' || subject.grade === 'C') {
                            gradeClass = 'grade-average';
                        } else {
                            gradeClass = 'grade-poor';
                        }
                        
                        row.innerHTML = `
                            <td>${subject.name}</td>
                            <td>${subject.marksObtained}</td>
                            <td>${subject.maxMarks}</td>
                            <td class="${gradeClass}">${subject.grade}</td>
                            <td>${subject.remarks}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                } else {
                    // Show no data message
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" style="text-align: center;">No subject data available</td>`;
                    tableBody.appendChild(row);
                }
                
                // Update summary
                document.getElementById('totalMarks').textContent = resultData.totalMarks;
                document.getElementById('percentage').textContent = resultData.percentage + '%';
                document.getElementById('overallGrade').textContent = resultData.overallGrade;
                document.getElementById('resultStatus').textContent = resultData.resultStatus;
                
                // Create charts if we have data
                if (resultData.subjects && resultData.subjects.length > 0) {
                    createCharts(resultData);
                }
            }
            
            // Create charts
            function createCharts(resultData) {
                // Destroy existing charts
                if (marksChart) marksChart.destroy();
                if (gradeDistributionChart) gradeDistributionChart.destroy();
                
                // Prepare data for charts
                const subjectNames = resultData.subjects.map(subject => subject.name);
                const marksObtained = resultData.subjects.map(subject => subject.marksObtained);
                const maxMarks = resultData.subjects.map(subject => subject.maxMarks);
                
                const gradeCounts = {
                    'A+': 0, 'A': 0, 'B+': 0, 'B': 0, 'C': 0, 'D': 0, 'F': 0
                };
                
                resultData.subjects.forEach(subject => {
                    if (gradeCounts[subject.grade] !== undefined) {
                        gradeCounts[subject.grade]++;
                    }
                });
                
                // Create marks chart
                const marksCtx = document.getElementById('marksChart').getContext('2d');
                marksChart = new Chart(marksCtx, {
                    type: 'bar',
                    data: {
                        labels: subjectNames,
                        datasets: [
                            {
                                label: 'Marks Obtained',
                                data: marksObtained,
                                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                borderColor: 'rgba(52, 152, 219, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Maximum Marks',
                                data: maxMarks,
                                backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                borderColor: 'rgba(231, 76, 60, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Subject-wise Marks Comparison'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                
                // Create grade distribution chart
                const gradeCtx = document.getElementById('gradeDistributionChart').getContext('2d');
                gradeDistributionChart = new Chart(gradeCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(gradeCounts).filter(grade => gradeCounts[grade] > 0),
                        datasets: [{
                            data: Object.values(gradeCounts).filter(count => count > 0),
                            backgroundColor: [
                                'rgba(46, 204, 113, 0.7)',
                                'rgba(52, 152, 219, 0.7)',
                                'rgba(155, 89, 182, 0.7)',
                                'rgba(241, 196, 15, 0.7)',
                                'rgba(230, 126, 34, 0.7)',
                                'rgba(231, 76, 60, 0.7)'
                            ],
                            borderColor: [
                                'rgba(46, 204, 113, 1)',
                                'rgba(52, 152, 219, 1)',
                                'rgba(155, 89, 182, 1)',
                                'rgba(241, 196, 15, 1)',
                                'rgba(230, 126, 34, 1)',
                                'rgba(231, 76, 60, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Grade Distribution'
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // Initialize the application
            init();
        });
    </script>
</body>
</html>